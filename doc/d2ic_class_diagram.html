<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D2IC - Diagramme de classes</title>
  <style>
    :root {
      color-scheme: light;
    }
    body {
      margin: 0;
      padding: 24px;
      font-family: "EB Garamond", "Times New Roman", serif;
      background: linear-gradient(180deg, #f7f3ea 0%, #f0efe8 45%, #f6f2ea 100%);
      color: #1a1a1a;
    }
    h1 {
      font-size: 28px;
      margin: 0 0 12px 0;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    p {
      margin: 0 0 20px 0;
      max-width: 900px;
      line-height: 1.4;
    }
    .panel {
      background: #fbfaf6;
      border: 1px solid #e3d9c7;
      box-shadow: 0 12px 30px rgba(50, 40, 20, 0.08);
      padding: 18px;
      border-radius: 10px;
    }
    .mermaid {
      font-family: "IBM Plex Mono", "Courier New", monospace;
      font-size: 13px;
    }
    .error {
      display: none;
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #e3b7b7;
      background: #fff5f5;
      color: #5a1111;
      font-family: "IBM Plex Mono", "Courier New", monospace;
      white-space: pre-wrap;
      line-height: 1.35;
    }
    .error.is-visible {
      display: block;
    }
    .muted {
      opacity: 0.8;
    }
    .badge {
      display: inline-block;
      border-radius: 6px;
      padding: 2px 8px;
      margin-left: 6px;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      font-size: 13px;
      line-height: 1.2;
      background: #ffffff80;
    }
    .badge.abstract {
      background:#fff3cd;
      border:1px solid #856404;
    }
    .badge.concrete {
      background:#d4edda;
      border:1px solid #155724;
    }
    .badge.py {
      border: 2px solid #333;
    }
    .badge.jax {
      border: 2px dashed #1f77b4;
    }
    .badge.hybrid {
      border: 2px dotted #6f42c1;
    }
  </style>
</head>
<body>
  <h1>D2IC - Diagramme de classes</h1>
  <p>
    Diagramme Mermaid base sur les classes principales du module D2IC
    (dossier <code>D2IC/d2ic</code>) et leurs relations.
  </p>
  <div class="panel">
    <div class="mermaid" id="mermaid-diagram"></div>
    <textarea id="mermaid-source" style="display:none">
	flowchart TB
	  %% Une colonne (= une abstraction) :
	  %%   haut: classe abstraite
	  %%   milieu: classes filles
	  %%   bas: dataclasses / conteneurs
	
	  subgraph DIC_BOX["DICBase"]
	    direction TB
	    DICBase["«abstract»<br/><b>DICBase</b><br/><br/>+prepare()<br/>+run()"]
	    DICMeshBased["<b>DICMeshBased</b><br/><br/>+prepare()<br/>+set_initial_guess()<br/>+run()"]
	    DICInitMotion["<b>DICInitMotion</b><br/><br/>+prepare()<br/>+run()"]
	
	  end
	
	  subgraph BATCH_BOX["BatchBase"]
	    direction TB
	    BatchBase["«abstract»<br/><b>BatchBase</b><br/><br/>+run()<br/>+before()<br/>+sequence()<br/>+end()"]
	    BatchMeshBased["<b>BatchMeshBased</b><br/><br/>+before()<br/>+sequence()<br/>+end()"]
	
	  end
	
	  subgraph SOLVER_BOX["SolverBase"]
	    direction TB
	    SolverBase["«abstract»<br/><b>SolverBase</b><br/><br/>+compile()<br/>+solve()"]
	    LocalGaussNewtonSolver["<b>LocalGaussNewtonSolver</b>"]
	    GlobalCGSolver["<b>GlobalCGSolver</b>"]
	    TranslationZNCCSolver["<b>TranslationZNCCSolver</b>"]
	  end
	
	  subgraph PROP_BOX["DisplacementPropagatorBase"]
	    direction TB
	    DisplacementPropagatorBase["«abstract»<br/><b>DisplacementPropagatorBase</b><br/><br/>+propagate()"]
	    PreviousDisplacementPropagator["<b>PreviousDisplacementPropagator</b>"]
	    ConstantVelocityPropagator["<b>ConstantVelocityPropagator</b>"]
	  end
	
	  %% Inheritance (dans chaque boîte)
	  DICBase -->|inherits| DICMeshBased
	  DICBase -->|inherits| DICInitMotion
	  BatchBase -->|inherits| BatchMeshBased
	  SolverBase -->|inherits| LocalGaussNewtonSolver
	  SolverBase -->|inherits| GlobalCGSolver
	  SolverBase -->|inherits| TranslationZNCCSolver
	  DisplacementPropagatorBase -->|inherits| PreviousDisplacementPropagator
	  DisplacementPropagatorBase -->|inherits| ConstantVelocityPropagator
	
	  %% Liens "core" (minimaux, en pointillés pour éviter le fouillis)
	  DICMeshBased -.-> SolverBase
	  DICInitMotion -.-> SolverBase
	  BatchMeshBased -.->|uses| DICMeshBased
	  BatchMeshBased -.->|warm start| DisplacementPropagatorBase
	
	  %% Styles (3 catégories)
	  style DICBase fill:#fff3cd,stroke:#856404
	  style BatchBase fill:#fff3cd,stroke:#856404
	  style SolverBase fill:#fff3cd,stroke:#856404
	  style DisplacementPropagatorBase fill:#fff3cd,stroke:#856404
	
	  style DICMeshBased fill:#d4edda,stroke:#155724
	  style DICInitMotion fill:#d4edda,stroke:#155724
	  style BatchMeshBased fill:#d4edda,stroke:#155724
	  style LocalGaussNewtonSolver fill:#d4edda,stroke:#155724,stroke-width:3px,stroke-dasharray: 6 4
	  style GlobalCGSolver fill:#d4edda,stroke:#155724,stroke-width:3px,stroke-dasharray: 6 4
	  style TranslationZNCCSolver fill:#d4edda,stroke:#155724,stroke-width:3px,stroke-dasharray: 2 3
	  style PreviousDisplacementPropagator fill:#d4edda,stroke:#155724
	  style ConstantVelocityPropagator fill:#d4edda,stroke:#155724
	
    </textarea>
    <div class="muted" style="margin-top:12px; font-family: system-ui, -apple-system, Segoe UI, sans-serif; font-size: 13px;">
      <strong>Légende</strong> :
      <span class="badge abstract" style="margin-left:8px;">abstraite</span>
      <span class="badge concrete">concrète</span>
      <span style="margin-left:10px;"><strong>Backend</strong> :</span>
      <span class="badge py">Python</span>
      <span class="badge jax">JAX</span>
      <span class="badge hybrid">hybride</span>
    </div>
    <div id="mermaid-error" class="error"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const errorEl = document.getElementById("mermaid-error");
      const diagramEl = document.getElementById("mermaid-diagram");
      const sourceEl = document.getElementById("mermaid-source");

      const showError = (title, details) => {
        if (!errorEl) return;
        errorEl.classList.add("is-visible");
        const msg = [
          title,
          "",
          details || "(aucun detail fourni)",
          "",
          "Astuce: ouvre les DevTools (F12) > Console pour plus de logs.",
        ].join("\n");
        errorEl.textContent = msg;
      };

      if (typeof mermaid === "undefined") {
        showError(
          "Mermaid n'a pas pu etre charge.",
          "La page utilise un CDN; verifie ta connexion reseau / proxy, ou heberge Mermaid en local."
        );
        return;
      }

      mermaid.parseError = (err) => {
        const detail =
          typeof err === "string" ? err : (err && (err.str || err.message)) ? (err.str || err.message) : JSON.stringify(err, null, 2);
        showError("Erreur Mermaid (parseError):", detail);
        console.error("Mermaid parseError:", err);
      };

      mermaid.initialize({
        startOnLoad: false,
        theme: "neutral",
        logLevel: "debug",
      });

      (async () => {
        try {
          const text = (sourceEl ? sourceEl.value : "").trim();
          if (!diagramEl) {
            showError("Element de rendu introuvable:", "#mermaid-diagram");
            return;
          }
          diagramEl.textContent = text;
          if (typeof mermaid.parse === "function") {
            await mermaid.parse(text);
          } else if (mermaid.mermaidAPI && typeof mermaid.mermaidAPI.parse === "function") {
            mermaid.mermaidAPI.parse(text);
          }
          await mermaid.run({ querySelector: "#mermaid-diagram" });
        } catch (err) {
          showError("Erreur Mermaid (exception):", (err && err.message) ? err.message : String(err));
          console.error("Mermaid exception:", err);
        }
      })();
    });
  </script>
</body>
</html>
